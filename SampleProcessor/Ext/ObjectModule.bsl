

Функция ПутьКЛогу()

	Возврат "c:/Work/projects/sberdevices/dev/1cbench/bench/logs/benchmark_1c.log";

КонецФункции



Процедура ЗаписатьВЛог(ТекстСообщения)

	Стр = ТекстСообщения;



	Попытка

		Запись = Новый ЗаписьТекста(ПутьКЛогу(), КодировкаТекста.UTF8);

		Запись.ЗаписатьСтроку(Стр);

		Запись.Закрыть();

	Исключение

		ТД = Новый ТекстовыйДокумент;

		ФайлЛога = Новый Файл(ПутьКЛогу());

		Если ФайлЛога.Существует() Тогда

			ТД.Прочитать(ПутьКЛогу(), КодировкаТекста.UTF8);

		КонецЕсли;

		ТД.ДобавитьСтроку(Стр);

		ТД.Записать(ПутьКЛогу(), КодировкаТекста.UTF8);

	КонецПопытки;

КонецПроцедуры



Функция ЗапуститьРешениеОбертка() Экспорт

	Попытка

		Результат = ЗапуститьРешение();

        ЗаписатьВЛог("Result: " + ?(Результат, "true", "false"));

	Исключение

		Инф = ИнформацияОбОшибке();

		Сообщение = Инф.Описание;

		Если Инф.Причина <> Неопределено Тогда

			Сообщение = Сообщение + ": " + Инф.Причина.Описание;

		КонецЕсли;

		ЗаписатьВЛог("Error: " + Сообщение);

	КонецПопытки;

КонецФункции









		   

Функция ЗапуститьРешение() Экспорт

 	// Подготовка тестовых данных: создаём поставщика
 	Поставщик = Справочники.Контрагенты.НайтиПоНаименованию("Тестовый поставщик");

	Если Поставщик.Пустая() Тогда
		Поставщик = Справочники.Контрагенты.СоздатьЭлемент();
		Поставщик.Наименование = "Тестовый поставщик";
		Поставщик.Записать();
		Поставщик = Поставщик.Ссылка; 
	КонецЕсли;    
	
	ДругойПоставщик = Справочники.Контрагенты.НайтиПоНаименованию("Другой поставщик");

	Если ДругойПоставщик.Пустая() Тогда
		ДругойПоставщик = Справочники.Контрагенты.СоздатьЭлемент();
		ДругойПоставщик.Наименование = "Другой поставщик";
		ДругойПоставщик.Записать();
		ДругойПоставщик = Поставщик.Ссылка; 
	КонецЕсли;


 // Создаём вид цен для теста (если нужен)
 ВидЦен = Справочники.ВидыЦен.НайтиПоНаименованию("Базовая");

 Если ВидЦен.Пустая() Тогда
  ВидЦен = Справочники.ВидыЦен.СоздатьЭлемент();
  ВидЦен.Наименование = "Базовая";
  ВидЦен.Записать(); 
  ВидЦен = ВидЦен.Ссылка; 
 КонецЕсли;

 // Создаём товары для теста
 // Товар 1 - с ценой (не должен попасть в список)
 Товар1 = Справочники.Товары.СоздатьЭлемент();
 Товар1.Наименование = "Товар с ценой";
 Товар1.Поставщик = Поставщик;
 Товар1.Записать();

 МенеджерЦены1 = РегистрыСведений.ЦеныТоваров.СоздатьМенеджерЗаписи();
 МенеджерЦены1.Период = ТекущаяДатаСеанса();
 МенеджерЦены1.Товар = Товар1.Ссылка;
 МенеджерЦены1.ВидЦен = ВидЦен;
 МенеджерЦены1.Цена = 100;
 МенеджерЦены1.Записать();

 // Товар 2 - без цены (должен попасть в список)
 Товар2 = Справочники.Товары.СоздатьЭлемент();
 Товар2.Наименование = "Товар без цены 1";
 Товар2.Поставщик = Поставщик;
 Товар2.Записать();

 // Товар 3 - без цены (должен попасть в список)
 Товар3 = Справочники.Товары.СоздатьЭлемент();
 Товар3.Наименование = "Товар без цены 2";
 Товар3.Поставщик = Поставщик;
 Товар3.Записать();

 Товар4 = Справочники.Товары.СоздатьЭлемент();
 Товар4.Наименование = "Товар другого поставщика";
 Товар4.Поставщик = ДругойПоставщик;
 Товар4.Записать();

 // Формируем ожидаемый список товаров без цен
 ОжидаемыеТовары = Новый СписокЗначений;
 ОжидаемыеТовары.Добавить(Товар2.Ссылка);
 ОжидаемыеТовары.Добавить(Товар3.Ссылка);

 // Вызов функции задачи
 СписокТоваров = НеУстановленыЦены(Поставщик);

 // Вызов функции валидатора для проверки решения задачи
 РезультатПроверки = ЗадачаРешена(СписокТоваров, ОжидаемыеТовары);

 // Удаление тестовых данных
 // Удаляем запись регистра цен
 МенеджерУдаления = РегистрыСведений.ЦеныТоваров.СоздатьМенеджерЗаписи();
 МенеджерУдаления.Период = МенеджерЦены1.Период;
 МенеджерУдаления.Товар = Товар1.Ссылка;
 МенеджерУдаления.ВидЦен = ВидЦен;
 МенеджерУдаления.Удалить();

 // Удаляем товары
 Товар1.Удалить();
 Товар2.Удалить();
 Товар3.Удалить();
 Товар4.Удалить();

 // Удаляем контрагентов
 Поставщик.ПолучитьОбъект().Удалить();
 ДругойПоставщик.ПолучитьОбъект().Удалить();

 // Удаляем вид цен
 ВидЦен.ПолучитьОбъект().Удалить();

 Возврат РезультатПроверки;

КонецФункции


Функция НеУстановленыЦены(Поставщик) Экспорт

 // Запрос для получения товаров поставщика, у которых нет записей в регистре ЦеныТоваров
 Запрос = Новый Запрос;
 Запрос.Текст =
 "ВЫБРАТЬ
 | Товары.Ссылка КАК Товар
 |ИЗ
 | Справочник.Товары КАК Товары
 |  ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныТоваров КАК ЦеныТоваров
 |  ПО Товары.Ссылка = ЦеныТоваров.Товар
 |ГДЕ
 | Товары.Поставщик = &Поставщик
 | И Товары.ЭтоГруппа = ЛОЖЬ
 | И НЕ Товары.ПометкаУдаления
 | И ЦеныТоваров.Товар ЕСТЬ NULL
 |УПОРЯДОЧИТЬ ПО
 | Товар";

 Запрос.УстановитьПараметр("Поставщик", Поставщик);

 Результат = Запрос.Выполнить();
 Выборка = Результат.Выбрать();

 // Создаём список значений для возврата
 СписокТоваров = Новый СписокЗначений;

 Пока Выборка.Следующий() Цикл
  СписокТоваров.Добавить(Выборка.Товар);
 КонецЦикла;

 Возврат СписокТоваров;

КонецФункции

Функция ЗадачаРешена(СписокТоваров, ОжидаемыеТовары) Экспорт

	// Проверяем тип результата
	Если ТипЗнч(СписокТоваров) <> Тип("СписокЗначений") Тогда
		Возврат Ложь;
	КонецЕсли;

	// Проверяем количество элементов
	Если СписокТоваров.Количество() <> ОжидаемыеТовары.Количество() Тогда
		Возврат Ложь;
	КонецЕсли;

	// Проверяем, что все ожидаемые товары присутствуют в списке
	Для Каждого ОжидаемыйТовар Из ОжидаемыеТовары Цикл
		ЭлементСписка = СписокТоваров.НайтиПоЗначению(ОжидаемыйТовар.Значение);
		Если ЭлементСписка = Неопределено Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;

	// Проверяем, что в списке нет лишних товаров
	Для Каждого ЭлементСписка Из СписокТоваров Цикл
		Найден = Ложь;
		Для Каждого ОжидаемыйТовар Из ОжидаемыеТовары Цикл
			Если ЭлементСписка.Значение = ОжидаемыйТовар.Значение Тогда
				Найден = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;

		Если НЕ Найден Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;

	Возврат Истина;

КонецФункции
