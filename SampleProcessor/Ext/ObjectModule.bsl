

Функция ПутьКЛогу()

	Возврат "c:/Work/projects/sberdevices/dev/1cbench/bench/logs/benchmark_1c.log";

КонецФункции



Процедура ЗаписатьВЛог(ТекстСообщения)

	Стр = ТекстСообщения;



	Попытка

		Запись = Новый ЗаписьТекста(ПутьКЛогу(), КодировкаТекста.UTF8);

		Запись.ЗаписатьСтроку(Стр);

		Запись.Закрыть();

	Исключение

		ТД = Новый ТекстовыйДокумент;

		ФайлЛога = Новый Файл(ПутьКЛогу());

		Если ФайлЛога.Существует() Тогда

			ТД.Прочитать(ПутьКЛогу(), КодировкаТекста.UTF8);

		КонецЕсли;

		ТД.ДобавитьСтроку(Стр);

		ТД.Записать(ПутьКЛогу(), КодировкаТекста.UTF8);

	КонецПопытки;

КонецПроцедуры



Функция ЗапуститьРешениеОбертка() Экспорт

	Попытка

		Результат = ЗапуститьРешение();

        ЗаписатьВЛог("Result: " + ?(Результат, "true", "false"));

	Исключение

		Инф = ИнформацияОбОшибке();

		Сообщение = Инф.Описание;

		Если Инф.Причина <> Неопределено Тогда

			Сообщение = Сообщение + ": " + Инф.Причина.Описание;

		КонецЕсли;

		ЗаписатьВЛог("Error: " + Сообщение);

	КонецПопытки;

КонецФункции









		   

Функция ЗапуститьРешение() Экспорт

	// Подготовка тестовых данных
	Письмо = Справочники.ИсходящиеПисьма.НайтиПоНаименованию("Предлагаем телевизоры Sony К3456P со скидкой");

	// Вызываем функцию решения
	Отправитель = "noreply@mycompany.com";
	Сообщение = СоздатьИнтернетПочтовоеСообщение(Письмо.Ссылка, Отправитель);

	// Вызываем функцию валидатора для проверки решения задачи
	РезультатПроверки = ЗадачаРешена(Сообщение);

	Возврат РезультатПроверки;

КонецФункции

Функция СоздатьИнтернетПочтовоеСообщение(Письмо, Отправитель) Экспорт

	// Создаем новое интернет-почтовое сообщение
	Сообщение = Новый ИнтернетПочтовоеСообщение;

	// Устанавливаем отправителя
	Сообщение.Отправитель = Отправитель;

	// Устанавливаем тему письма из наименования справочника
	Сообщение.Тема = Письмо.Наименование;

	// Добавляем получателей из табличной части
	Для Каждого СтрокаПолучателя Из Письмо.Получатели Цикл
		Если ЗначениеЗаполнено(СтрокаПолучателя.ЭлектроннаяПочта) Тогда
			Сообщение.Получатели.Добавить(СтрокаПолучателя.ЭлектроннаяПочта);
		КонецЕсли;
	КонецЦикла;

	// Если в реквизите Получатель также указан адрес, добавляем его
	Если ЗначениеЗаполнено(Письмо.Получатель) Тогда
		// Проверяем, не добавлен ли уже этот адрес из табличной части
		АдресУжеДобавлен = Ложь;
		Для Каждого Получатель Из Сообщение.Получатели Цикл
			Если Получатель.Адрес = Письмо.Получатель Тогда
				АдресУжеДобавлен = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;

		Если НЕ АдресУжеДобавлен Тогда
			Сообщение.Получатели.Добавить(Письмо.Получатель);
		КонецЕсли;
	КонецЕсли;

	// Устанавливаем текст сообщения
	Если ЗначениеЗаполнено(Письмо.Текст) Тогда
		ТекстСообщения = Сообщение.Тексты.Добавить(Письмо.Текст);
		ТекстСообщения.ТипТекста = ТипТекстаПочтовогоСообщения.ПростойТекст;
	КонецЕсли;

	// Обрабатываем вложения из хранилища значения (если есть)
	Если ЗначениеЗаполнено(Письмо.Содержимое) Тогда
		Попытка
			Вложения = Письмо.Содержимое.Получить();
			Если ТипЗнч(Вложения) = Тип("Массив") Тогда
				Для Каждого Вложение Из Вложения Цикл
				 // Предполагаем, что вложение имеет свойства ИмяФайла и Данные
					Если ТипЗнч(Вложение) = Тип("Структура") Тогда
						Если Вложение.Свойство("ИмяФайла") И Вложение.Свойство("Данные") Тогда
						   Вл = Сообщение.Вложения.Добавить(Вложение.Данные, Вложение.ИмяФайла);
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		Исключение
		// Если не удалось обработать вложения, просто пропускаем
		КонецПопытки;
	КонецЕсли;

	Возврат Сообщение;

КонецФункции

Функция ЗадачаРешена(Сообщение) Экспорт

	// Ожидаемые значения для проверки (схематично)
	ОжидаемыйОтправитель = "noreply@mycompany.com"; // Email отправителя
	ОжидаемаяТема = "Предлагаем телевизоры Sony К3456P со скидкой"; // Тема письма
	ОжидаемоеКоличествоПолучателей = 1; // Количество получателей
	ОжидаемыйПолучатель1 = "givotnovodstvo@mail.ru"; // Email получателя
	ОжидаемыйТекст = "Предлагаем приобрести телевизоры Sony К3456P со скидкой 30%"; // Текст сообщения

	// Проверяем, что результат является ИнтернетПочтовымСообщением
	Если ТипЗнч(Сообщение) <> Тип("ИнтернетПочтовоеСообщение") Тогда
		Возврат Ложь;
	КонецЕсли;

	Если ТипЗнч(Сообщение.Отправитель) <> Тип("ИнтернетПочтовыйАдрес") Тогда
		Возврат Ложь;
	КонецЕсли;

	Если Сообщение.Отправитель.Адрес <> ОжидаемыйОтправитель Тогда
		Возврат Ложь;
	КонецЕсли;

	// Проверяем тему письма
	Если Сообщение.Тема <> ОжидаемаяТема Тогда
		Возврат Ложь;
	КонецЕсли;

	// Проверяем количество получателей
	Если Сообщение.Получатели.Количество() <> ОжидаемоеКоличествоПолучателей Тогда
		Возврат Ложь;
	КонецЕсли;

	// Проверяем адреса получателей
	Если Сообщение.Получатели.Количество() >= 1 Тогда
		Если ТипЗнч(Сообщение.Получатели[0]) <> Тип("ИнтернетПочтовыйАдрес") Тогда
			Возврат Ложь;
		КонецЕсли;

		Если Сообщение.Получатели[0].Адрес <> ОжидаемыйПолучатель1 Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЕсли;

	// Проверяем наличие текста
	Если Сообщение.Тексты.Количество() <> 1 Тогда
		Возврат Ложь;
	КонецЕсли;

	// Проверяем содержимое текста
	ТекстСообщения = Сообщение.Тексты[0].Текст;
	Если СтрНайти(ТекстСообщения, ОжидаемыйТекст) = 0 Тогда
		Возврат Ложь;
	КонецЕсли;

	// Проверяем, что дата отправления не установлена
	Если ЗначениеЗаполнено(Сообщение.ДатаОтправления) Тогда
		Возврат Ложь;
	КонецЕсли;

	Возврат Истина;       
 

КонецФункции
