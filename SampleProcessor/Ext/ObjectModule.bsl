



Процедура ЗаписатьВЛог(ТекстСообщения, ПутьКЛогу)

	Стр = ТекстСообщения;

	Попытка

		Запись = Новый ЗаписьТекста(ПутьКЛогу, КодировкаТекста.UTF8);

		Запись.ЗаписатьСтроку(Стр);

		Запись.Закрыть();

	Исключение

		ТД = Новый ТекстовыйДокумент;

		ФайлЛога = Новый Файл(ПутьКЛогу);

		Если ФайлЛога.Существует() Тогда

			ТД.Прочитать(ПутьКЛогу, КодировкаТекста.UTF8);

		КонецЕсли;

		ТД.ДобавитьСтроку(Стр);

		ТД.Записать(ПутьКЛогу, КодировкаТекста.UTF8);

	КонецПопытки;

КонецПроцедуры



Функция ЗапуститьРешениеОбертка(ПутьКЛогу) Экспорт

	Попытка

		Результат = ЗапуститьРешение();

        ЗаписатьВЛог("Result: " + ?(Результат, "true", "false"), ПутьКЛогу);

	Исключение

		Инф = ИнформацияОбОшибке();

		Сообщение = Инф.Описание;

		Если Инф.Причина <> Неопределено Тогда

			Сообщение = Сообщение + ": " + Инф.Причина.Описание;

		КонецЕсли;

		ЗаписатьВЛог("Error: " + Сообщение, ПутьКЛогу);

	КонецПопытки;

КонецФункции

Функция ЗапуститьРешение() Экспорт

	// Подготовка тестовых данных: создаём склад
	Склад = Справочники.Склады.НайтиПоНаименованию("Склад отдела продаж");

	// Формируем ожидаемые данные (минимальный остаток = 10)
	МинимальныйОстаток = 60; 
	
	// Путь к файлу JSON
	ФайлJson = ПолучитьИмяВременногоФайла("json");

	// Вызов функции задачи
	ВыгрузитьОстаткиСклада(Склад, МинимальныйОстаток, ФайлJson);

	// Вызов функции валидатора для проверки решения задачи
	РезультатПроверки = ЗадачаРешена(ФайлJson);

	// Удаляем временный файл JSON
	Попытка
		УдалитьФайлы(ФайлJson);
	Исключение
		// Игнорируем ошибки удаления файла
	КонецПопытки;

	Возврат РезультатПроверки;

КонецФункции


Процедура ВыгрузитьОстаткиСклада(Склад, МинимальныйОстаток, ФайлJson) Экспорт
	
	// Формируем запрос для получения остатков товаров
	Запрос = Новый Запрос;
	Запрос.Текст = "
		|ВЫБРАТЬ
		|	ТоварныеЗапасыОстатки.Товар КАК Товар,
		|	ТоварныеЗапасыОстатки.Товар.Код КАК Товар_Код,
		|	ТоварныеЗапасыОстатки.Товар.Наименование КАК Товар_Наименование,
		|	ТоварныеЗапасыОстатки.КоличествоОстаток КАК Остаток
		|ИЗ
		|	РегистрНакопления.ТоварныеЗапасы.Остатки(, Склад = &Склад) КАК ТоварныеЗапасыОстатки
		|ГДЕ
		|	ТоварныеЗапасыОстатки.КоличествоОстаток >= &МинимальныйОстаток
		|
		|УПОРЯДОЧИТЬ ПО
		|	Товар_Код";
	
	Запрос.УстановитьПараметр("Склад", Склад);
	Запрос.УстановитьПараметр("МинимальныйОстаток", МинимальныйОстаток);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	// Формируем массив для выгрузки в JSON
	МассивДанных = Новый Массив;
	
	Пока Выборка.Следующий() Цикл
		СтрокаДанных = Новый Структура;
		СтрокаДанных.Вставить("Товар_Код", Выборка.Товар_Код);
		СтрокаДанных.Вставить("Товар_Наименование", Выборка.Товар_Наименование);
		СтрокаДанных.Вставить("Остаток", Окр(Выборка.Остаток, 0, РежимОкругления.Окр15как20));
		
		МассивДанных.Добавить(СтрокаДанных);
	КонецЦикла;
	
	// Записываем данные в JSON файл
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.ОткрытьФайл(ФайлJson, , , Новый ПараметрыЗаписиJSON(, Символы.Таб));
	ЗаписатьJSON(ЗаписьJSON, МассивДанных);
	ЗаписьJSON.Закрыть();
	
КонецПроцедуры
Функция ЗадачаРешена(ФайлJson) Экспорт
	
	ОжидаемыеДанные = Новый Массив;

	// Только товары с остатком >= 60
	СтрокаТовар = Новый Структура;
	СтрокаТовар.Вставить("Товар_Код", "000000026");
	СтрокаТовар.Вставить("Товар_Наименование", "Молоко");
	СтрокаТовар.Вставить("Остаток", 100);
	ОжидаемыеДанные.Добавить(СтрокаТовар);    
	
	СтрокаТовар = Новый Структура;
	СтрокаТовар.Вставить("Товар_Код", "000000032");
	СтрокаТовар.Вставить("Товар_Наименование", "Торт");
	СтрокаТовар.Вставить("Остаток", 100);
	ОжидаемыеДанные.Добавить(СтрокаТовар);

	СтрокаТовар = Новый Структура;
	СтрокаТовар.Вставить("Товар_Код", "000000033");
	СтрокаТовар.Вставить("Товар_Наименование", "VekoNT02");
	СтрокаТовар.Вставить("Остаток", 195);
	ОжидаемыеДанные.Добавить(СтрокаТовар);

	// Проверяем существование файла
	ФайлОбъект = Новый Файл(ФайлJson);
	Если НЕ ФайлОбъект.Существует() Тогда
		Возврат Ложь;
	КонецЕсли;

	// Читаем JSON из файла
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.ОткрытьФайл(ФайлJson);
	МассивДанных = ПрочитатьJSON(ЧтениеJSON);
	ЧтениеJSON.Закрыть();

	// Проверяем тип результата
	Если ТипЗнч(МассивДанных) <> Тип("Массив") Тогда
		Возврат Ложь;
	КонецЕсли;

	// Проверяем количество элементов
	Если МассивДанных.Количество() <> 4 Тогда
		Возврат Ложь;
	КонецЕсли;

	// Проверяем каждый элемент
	Для Индекс = 0 По 2 Цикл
		ФактическаяСтрока = МассивДанных[Индекс];
		ОжидаемаяСтрока = ОжидаемыеДанные[Индекс];

		// Проверяем наличие обязательных полей
		Если НЕ ФактическаяСтрока.Свойство("Товар_Код")
			ИЛИ НЕ ФактическаяСтрока.Свойство("Товар_Наименование")
			ИЛИ НЕ ФактическаяСтрока.Свойство("Остаток") Тогда
			Возврат Ложь;
		КонецЕсли;

		// Проверяем значения полей
		Если ФактическаяСтрока.Товар_Код <> ОжидаемаяСтрока.Товар_Код
			ИЛИ ФактическаяСтрока.Товар_Наименование <> ОжидаемаяСтрока.Товар_Наименование
			ИЛИ ФактическаяСтрока.Остаток <> ОжидаемаяСтрока.Остаток Тогда
			Возврат Ложь;
		КонецЕсли;

		// Проверяем, что остаток - целое число
		Если ФактическаяСтрока.Остаток <> Окр(ФактическаяСтрока.Остаток, 0) Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;

	Возврат Истина;

КонецФункции
